<!doctype html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=450">
<title>Series Odds Calculator</title>
<style type="text/css">
    * { box-sizing: border-box; }
    fieldset { display: inline-block; }
    legend { text-align: center; }

    .menu-icon { position: absolute; top: 0; left: 0; padding: 1em; cursor: pointer; }
    #hide-config { display: none; }
    #hide-config:checked + .config-screen { display: none; }
    .config-background { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.25); }
    .config-menu { position: fixed; top: 3em; left: 1em; display: inline-block; background: white; box-shadow: 0px 3px 10px 0px rgba(0,0,0,0.5); }
    .config-menu > * { margin: 1em; }
    .config-menu fieldset { text-align: right; background: white; }
    .github-link > a { text-decoration: none; }
    .github-link > a:hover { text-decoration: underline; }

    #main { width: 400px; margin: auto; text-align: center; }
    .game fieldset { width: 100%; }
    .range { width: 300px; }
    .meter-outer { background: gray; position: relative; text-align: left; height: 3em; }
    .meter-color { width: 100%; height: 100%; }
    .meter-inner { position: absolute; height: 100%; }
    .meter-inner.team2 { right: 0; }
    .meter-label { position: absolute; padding: 0.5em; }
    .meter-label.team2 { right: 0; text-align: right; }
</style>

</head>
<body>

<div id="main"></div>

<label class="menu-icon" for="hide-config">â˜°</label>
<input type="checkbox" id="hide-config" checked>
<div class="config-screen">
    <label for="hide-config" class="config-background"></label>
    <div class="config-menu">
        <form id="set-globals">
            <fieldset>
                <legend>Configuration</legend>
                <label>Team 1: <input name="team1_name" value="Sharks" /></label><br>
                <label>Color: <input name="team1_background" value="#006d75" /></label><br>
                <label>Text Color: <input name="team1_color" value="white" /></label><br>
                <br>
                <label>Team 2: <input name="team2_name" value="Oilers" /></label><br>
                <label>Color: <input name="team2_background" value="#00205b" /></label><br>
                <label>Text Color: <input name="team2_color" value="white" /></label><br>
                <br>
                <button type="button" onclick="$('#hide-config').click()">Cancel</button>
                <button type="submit">Save</button>
            </fieldset>
        </form>
        <div class="github-link">
            <a href="https://github.com/jjclark1982/series-odds" target="_blank">
                <svg style="margin-bottom: -2px;" width="16px" height="16px" viewBox="0 0 33 33" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <path d="M16.608,0.455 C7.614,0.455 0.32,7.748 0.32,16.745 C0.32,23.942 4.987,30.047 11.46,32.201 C12.275,32.351 12.572,31.848 12.572,31.416 C12.572,31.03 12.558,30.005 12.55,28.646 C8.019,29.63 7.063,26.462 7.063,26.462 C6.322,24.58 5.254,24.079 5.254,24.079 C3.775,23.069 5.366,23.089 5.366,23.089 C7.001,23.204 7.861,24.768 7.861,24.768 C9.314,27.257 11.674,26.538 12.602,26.121 C12.75,25.069 13.171,24.351 13.636,23.944 C10.019,23.533 6.216,22.135 6.216,15.893 C6.216,14.115 6.851,12.66 7.893,11.522 C7.725,11.11 7.166,9.453 8.053,7.211 C8.053,7.211 9.42,6.773 12.532,8.881 C13.831,8.519 15.225,8.339 16.61,8.332 C17.994,8.339 19.387,8.519 20.688,8.881 C23.798,6.773 25.163,7.211 25.163,7.211 C26.052,9.453 25.493,11.11 25.326,11.522 C26.37,12.66 27,14.115 27,15.893 C27,22.151 23.191,23.528 19.563,23.931 C20.147,24.434 20.668,25.428 20.668,26.948 C20.668,29.125 20.648,30.882 20.648,31.416 C20.648,31.852 20.942,32.359 21.768,32.2 C28.236,30.041 32.899,23.94 32.899,16.745 C32.899,7.748 25.605,0.455 16.608,0.455" fill="#151513"></path>
                    </g>
                </svg>
                Source Code
            </a>
        </div>
    </div>
</div>

<script type="text/html" id="play-chance-template">
    <p class="play-chance">
        Probability that Game <span data-name="game_no"></span>
        gets played: <span data-name="play_pct"></span>
    </p>
</script>

<script type="text/html" id="game-template">
    <div class="game">
        <fieldset>
            <legend>Game <span data-name="game_no"></span></legend>
            <span>
                <input class="range" type="range" min="0" max="100" pattern="\d*" onchange="updateMeters(this)" onmousemove="updateMeters(this)" ontouchmove="updateMeters(this)">
            </span>
            <br>
        </div>
    </fieldset>
</script>

<script type="text/html" id="final-win-template">
    <div class="final-win">
        <div class="meter-outer">
            <div class="meter-inner team1" data-name="team1_pct" data-target="style.width">
                <div class="meter-color" data-name="team1_background" data-target="style.background"></div>
            </div>
            <div class="meter-inner team2" data-name="team2_pct" data-target="style.width">
                <div class="meter-color" data-name="team2_background" data-target="style.background"></div>
            </div>
            <div class="meter-label team2" data-name="team2_color" data-target="style.color">
                <span data-name="team2_name"></span><br>
                <span data-name="team2_pct"></span>
            </div>
            <div class="meter-label team1" data-name="team1_color" data-target="style.color">
                <span data-name="team1_name"></span><br>
                <span data-name="team1_pct"></span>
            </div>
        </div>
    </div>
</script>

<script>

/* -------- library -------- */

var $ = document.querySelector.bind(document);
var $$ = document.querySelectorAll.bind(document);

function percent (p, trunc) {
    if (trunc) {
        // truncate to between 0 and 2 figures of precision
        return Math.round(p * 10000) / 100 + "%";
    }
    else {
        return p * 100 + "%";
    }
}

function parseQuery(query) {
    query = query.replace(/^\?|\/$/g,'');
    var items = query.split('&');
    var obj = {};
    items.forEach(function(item){
        var parts = item.split('=');
        var key = decodeURIComponent(parts[0]);
        var value = decodeURIComponent(parts[1]);
        obj[key] = value;
    });
    return obj;
}

function getValues(form) {
    var values = {};
    var fields = form.querySelectorAll('[name]');
    for (var i = 0; i < fields.length; i++) {
        var field = fields[i];
        var value = field.value;
        if (field.type == 'checkbox') {
            value = field.checked;
        }
        values[field.name] = value;
    }
    return values
}

function setValues(el, name, value, searchAttr) {
    searchAttr = searchAttr || 'data-name';
    var items = el.querySelectorAll('['+searchAttr+'="'+name+'"]');
    for (var i = 0; i < items.length; i++) {
        var el = items[i];
        var target = el.getAttribute('data-target') || 'value';
        if (target == 'value') {
            // when no 'data-target' is given, set the 'value' which varies by tag
            if (el.tagName == 'INPUT') {
                if (el.type == 'checkbox') {
                    el.checked = !!value;
                }
                else {
                    el.value = value;
                }
            }
            else {
                el.textContent = value;
                if ('textContent' in el) {
                    el.textContent = value;
                }
                else {
                    el.innerText = value; // IE8 support
                }
            }
        }
        else {
            // when some 'data-target' is given, set that attribute
            // e.g.: <data-name="banner_size" data-target="width"> would run
            //       el.width = value;
            // but if 'data-target' has more than one part, drill down to set it
            // e.g.: <data-name="banner_size" data-target="style.width"> would run
            //       el.style.width = value;
            var parts = target.split('.');
            var cursor = el;
            while (parts.length > 1) {
                cursor = cursor[parts.shift()];
            }
            cursor[parts[0]] = value;
        }
    }
}

function setMultiValues(el, context) {
    Object.keys(context).forEach(function(key){
        setValues(el, key, context[key]);
    });
}

function render(template, globals, locals) {
    template = template || '';
    var context = Object.assign({}, globals);
    context = Object.assign(context, locals);

    var container = document.createElement('div');
    var html = template.innerHTML || template;
    container.innerHTML = html.trim();
    var el = container.firstChild;

    setMultiValues(el, context);

    return el;
}

/* -------- main -------- */

var globals = {};

if (document.location.search) {
    globals = parseQuery(document.location.search);
    setMultiValues($("#set-globals"), globals);
}
else {
    globals = getValues($("#set-globals"));
}

$("#set-globals").onsubmit = function(event) {
    globals = getValues(event.target);
    setMultiValues($('#main'), globals);
    $("#hide-config").click();
    // return false;
}

function renderMain() {
    var mainEl = $('#main');
    mainEl.innerHTML = '';
    for (var i = 1; i <= 7; i++) {
        var locals = { game_no: i };
        var game = render($('#game-template'), globals, locals);
        if (i >= 5) {
            var play = render($('#play-chance-template'), globals, locals);
            game.prepend(play);
        }
        if (i >= 4) {
            var win = render($('#final-win-template'), globals, locals);
            game.append(win);
        }
        mainEl.append(game);
    }
}

function seriesProb (game, wins, max_games, prob) {
    if (wins >= 4) {
        return 1;
    }
    else if (game - wins >= 4) {
        return 0;
    }
    else if (game > max_games) {
        return 0;
    }
    else {
        return(seriesProb(game+1, wins, max_games, prob) * (1-prob[game])
             + seriesProb(game+1, wins+1, max_games, prob) * (prob[game]));
    }
}

function updateMeters(input) {
    var team1Probs = [];
    var team2Probs = [];
    var inputs = $$(".range");
    for (var i = 0; i < inputs.length; i++) {
        team1Probs[i] = inputs[i].value / 100;
        team2Probs[i] = 1 - (inputs[i].value/100);
    }

    var team1WonYet = [];
    var team2WonYet = [];
    var noWinYet = [];
    for (var max_games = 0; max_games < 7; max_games++) {
        team1WonYet[max_games] = seriesProb(0, 0, max_games, team1Probs);
        team2WonYet[max_games] = seriesProb(0, 0, max_games, team2Probs);
        noWinYet[max_games] = 1 - team1WonYet[max_games] - team2WonYet[max_games];
    }

    var games = $$(".game");
    for (var i = 0; i < 7; i++) {
        setMultiValues(games[i], {
            team1_pct: percent(team1WonYet[i], true),
            team2_pct: percent(team2WonYet[i], true),
            play_pct: percent(noWinYet[i-1], true)
        });
    }
}

/* -------- init -------- */

renderMain();
updateMeters();

</script>
