<!doctype html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=450">
<title>Series Odds Calculator</title>
<style type="text/css">
    * { box-sizing: border-box; }
    fieldset { display: inline-block; }
    legend { text-align: center; }

    .menu-icon { position: absolute; top: 0; left: 0; padding: 1em; cursor: pointer; }
    #show-config { display: none; }
    #show-config:checked + .config-screen { display: block; }
    .config-screen { display: none; }
    .config-screen-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; }
    .config-form { position: fixed; top: 2.5em; text-align: right; display: inline-block; pointer-events: initial; }

    #main { width: 400px; margin: auto; text-align: center; }
    .game fieldset { width: 100%; }
    .meter-outer { background: gray; position: relative; text-align: left; }
    .team1-meter { display: inline-block; padding: 0.5em; }
    .team2-meter { position: absolute; right: 0; padding: 0.5em; text-align: right; }
    .range { width: 250px; }
</style>

</head>
<body>

<label class="menu-icon" for="show-config">â˜°</label>
<input type="checkbox" id="show-config">
<div class="config-screen">
    <label for="show-config" class="config-screen-overlay"></label>
    <form class="config-form" id="set-globals">
        <fieldset>
            <legend>Configuration</legend>
            <label>Team 1: <input name="team1_name" value="Sharks" /></label><br>
            <label>Color: <input name="team1.style.background" value="#006d75" /></label><br>
            <label>Text: <input name="team1.style.color" value="white" /></label><br>
            <br>
            <label>Team 2: <input name="team2_name" value="Oilers" /></label><br>
            <label>Color: <input name="team2.style.background" value="#00205b" /></label><br>
            <label>Text: <input name="team2.style.color" value="white" /></label><br>
            <br>
            <button type="button" onclick="$('#show-config').click()">Cancel</button>
            <button type="submit">Save</button>
        </fieldset>
    </form>
</div>

<script type="text/html" id="play-chance-template">
    <p class="play-chance">
        Probability that Game <span name="game_no"></span> gets played:
        <span name="play_pct">70%</span>
    </p>
</script>

<script type="text/html" id="game-template">
    <div class="game">
        <fieldset>
            <legend class="game_label">Game <span name="game_no"></span></legend>
            <span>
                <input class="range" type="range" min="0" max="100" pattern="\d*" onchange="updateMeters(this)" onmousemove="updateMeters(this)" ontouchmove="updateMeters(this)">
            </span>
            <br>
        </div>
    </fieldset>
</script>

<script type="text/html" id="final-win-template">
    <div class="final-win">
        <div class="meter-outer">
            <div class="team2-meter" name="team2"><span name="team2_name"></span><br>&nbsp;<span name="team2_pct">15%</span></div>
            <div class="team1-meter" name="team1"><span name="team1_name"></span><br>&nbsp;<span name="team1_pct">15%</span></div>
        </div>
    </div>
</script>

<div id="main"></div>

<script>

/* -------- library -------- */

var $ = document.querySelector.bind(document);
var $$ = document.querySelectorAll.bind(document);

function parent(el, selector) {
    do {
        el = el.parentElement;
        if (el.matches(selector)) {
            return el;
        }
    } while (el != null);
    return null;
}

function percent (p, trunc) {
    if (trunc) {
        return Math.round(p * 10000) / 100 + "%";
    }
    else {
        return p * 100 + "%";
    }
}

function parseQuery(query) {
    query = query.replace(/^\?|\/$/g,'');
    var items = query.split('&');
    var obj = {};
    items.forEach(function(item){
        var parts = item.split('=');
        var key = decodeURIComponent(parts[0]);
        var value = decodeURIComponent(parts[1]);
        obj[key] = value;
    });
    return obj;
}

function getValues(form) {
    var values = {};
    var fields = form.querySelectorAll('[name]');
    for (var i = 0; i < fields.length; i++) {
        var field = fields[i];
        var value = field.value;
        if (field.type == 'checkbox') {
            value = field.checked;
        }
        values[field.name] = value;
    }
    return values
}

function setValues(el, key, value) {
    var parts = key.split('.');
    var name = parts[0];
    var attr = parts[1] || 'value';

    var items = el.querySelectorAll('[name="'+name+'"]');
    for (var i = 0; i < items.length; i++) {
        var el = items[i];
        if (attr == 'value') {
            if (el.tagName == 'INPUT') {
                if (el.type == 'checkbox') {
                    el.checked = !!value;
                }
                else {
                    el.value = value;
                }
            }
            else {
                el.textContent = value;
                if ('textContent' in el) {
                    el.textContent = value;
                }
                else {
                    el.innerText = value; // IE8 support
                }
            }
        }
        else if (attr == 'style') {
            if (parts[2]) {
                // e.g. team1.style.background = blue
                el.style[parts[2]] = value;
            }
            else {
                // e.g. team1.style: {color: white, background: blue}
                Object.assign(el.style, value);
            }
        }
        else {
            el[attr] = value;
        }
    }
}

function setMultiValues(el, context) {
    Object.keys(context).forEach(function(key){
        setValues(el, key, context[key]);
    });
}

function render(template, globals, locals) {
    template = template || '';
    var context = Object.assign({}, globals);
    context = Object.assign(context, locals);

    var container = document.createElement('div');
    var html = template.innerHTML || template;
    container.innerHTML = html.trim();
    var el = container.firstChild;

    setMultiValues(el, context);

    return el;
}

/* -------- main -------- */

var globals = {};

if (document.location.search) {
    globals = parseQuery(document.location.search);
    setMultiValues($("#set-globals"), globals);
}
else {
    globals = getValues($("#set-globals"));
}

$("#set-globals").onsubmit = function(event) {
    globals = getValues(event.target);
    setMultiValues($('#main'), globals);
    $("#show-config").click();
    // return false;
}

function renderMain() {
    var main = $("#main");
    main.innerHTML = '';
    for (var i = 1; i <= 7; i++) {
        var locals = { game_no: i }
        var game = render($('#game-template'), globals, locals);
        main.append(game);
        if (i >= 5) {
            var play = render($('#play-chance-template'), globals, locals);
            game.prepend(play);
        }
        if (i >= 4) {
            var win = render($('#final-win-template'), globals, locals);
            game.append(win);
        }
    }
}

function seriesProb (game, wins, max_games, prob) {
    if (wins >= 4) {
        return 1;
    }
    else if (game - wins >= 4) {
        return 0
    }
    else if (game > max_games) {
        return 0;
    }
    else {
        return(seriesProb(game+1, wins, max_games, prob) * (1-prob[game])
             + seriesProb(game+1, wins+1, max_games, prob) * (prob[game]));
    }
}

function updateMeters(input) {
    var team1Probs = [];
    var team2Probs = [];
    var inputs = $$(".range");
    for (var i = 0; i < inputs.length; i++) {
        team1Probs[i] = inputs[i].value / 100;
        team2Probs[i] = 1 - (inputs[i].value/100);
    }

    var team1WonYet = [];
    var team2WonYet = [];
    var noWinYet = [];
    for (var max_games = 0; max_games < 7; max_games++) {
        team1WonYet[max_games] = seriesProb(0, 0, max_games, team1Probs);
        team2WonYet[max_games] = seriesProb(0, 0, max_games, team2Probs);
        noWinYet[max_games] = 1 - team1WonYet[max_games] - team2WonYet[max_games];
    }

    var games = $$(".game");
    for (var i = 0; i < 7; i++) {
        setMultiValues(games[i], {
            team1_pct: percent(team1WonYet[i], true),
            team2_pct: percent(team2WonYet[i], true),
            "team1.style.width": percent(team1WonYet[i]),
            "team2.style.width": percent(team2WonYet[i]),
            play_pct: percent(noWinYet[i-1], true)
        });
    }
}

renderMain();
updateMeters();

</script>
