<!doctype html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>Series Odds Calculator</title>
<style type="text/css">
    * { box-sizing: border-box; }
    fieldset { display: inline-block; }
    legend { text-align: center; }

    .menu-icon { position: absolute; top: 0; left: 0; padding: 1em; cursor: pointer; }
    #show-config { display: none; }
    #show-config:checked + .config-screen { display: block; }
    .config-screen { display: none; }
    .config-screen-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; }
    .config-form { position: fixed; left: 2.5em; text-align: right; display: inline-block; pointer-events: initial; }

    #main { width: 400px; margin: auto; text-align: center; }
    .game fieldset { width: 100%; }
    .meter-outer { background: gray; position: relative; height: 3em; text-align: left; }
    .team1-meter { display: inline-block; padding: 0.5em; }
    .team2-meter { position: absolute; right: 0; padding: 0.5em; text-align: right; }
    .range { width: 250px; }
</style>

</head>
<body>

<label class="menu-icon" for="show-config">â˜°</label>
<input type="checkbox" id="show-config">
<div class="config-screen">
    <label for="show-config" class="config-screen-overlay"></label>
    <form class="config-form" id="set-globals">
        <fieldset>
            <legend>Configuration</legend>
            <label>Team 1: <input name="team1_name" value="Rangers" /></label><br>
            <label>Color: <input name="team1.style.color" value="black" /></label><br>
            <label>Background: <input name="team1.style.background" value="darkorange" /></label><br>
            <br>
            <label>Team 2: <input name="team2_name" value="Giants" /></label><br>
            <label>Color: <input name="team2.style.color" value="white" /></label><br>
            <label>Background: <input name="team2.style.background" value="blue" /></label><br>
            <br>
            <button type="button" onclick="$('#show-config').click()">Cancel</button>
            <button type="submit">Save</button>
        </fieldset>
    </form>
</div>

<script type="text/html" id="play-chance-template">
    <p class="play_chance" name="play_chance">
        Chance that Game <span name="game_no"></span> gets played:
        <span name="play_pct">70</span>%
    </p>
</script>

<script type="text/html" id="game-template">
    <div class="game">
        <fieldset>
            <legend class="game_label">Game <span name="game_no"></span></legend>
            <span>
                <input class="range" type="range" min="0" max="100" pattern="\d*" onchange="updateMeters(this)" onmousemove="updateMeters(this)">
            </span>
            <br>
        </div>
    </fieldset>
</script>

<script type="text/html" id="final-win-template">
    <div class="final-win">
        <div class="meter-outer">
            <div class="team2-meter" name="team2"><span name="team2_name"></span><br>&nbsp;<span name="team2_pct">15</span>%</div>
            <div class="team1-meter" name="team1"><span name="team1_name"></span><br>&nbsp;<span name="team1_pct">15</span>%</div>
        </div>
    </div>
</script>

<div id="main"></div>

<script>
var $ = document.querySelector.bind(document);
var $$ = document.querySelectorAll.bind(document);

function parent(el, selector) {
    do {
        el = el.parentElement;
        if (el.matches(selector)) {
            return el;
        }
    } while (el != null);
    return null;
}

function parseQuery(query) {
    query = query.replace(/^\?|\/$/g,'');
    var items = query.split('&');
    var obj = {};
    items.forEach(function(item){
        var parts = item.split('=');
        var key = decodeURIComponent(parts[0]);
        var value = decodeURIComponent(parts[1]);
        obj[key] = value;
    });
    return obj;
}

function getValues(form) {
    var values = {};
    var fields = form.querySelectorAll('[name]');
    for (var i = 0; i < fields.length; i++) {
        var field = fields[i];
        var value = field.value;
        if (field.type == 'checkbox') {
            value = field.checked;
        }
        values[field.name] = value;
    }
    return values
}

function setValues(el, key, value) {
    var parts = key.split('.');
    var name = parts[0];
    var attr = parts[1] || 'value';

    var items = el.querySelectorAll('[name="'+name+'"]');
    for (var i = 0; i < items.length; i++) {
        var el = items[i];
        if (attr == 'value') {
            if (el.tagName == 'INPUT') {
                if (el.type == 'checkbox') {
                    el.checked = !!value;
                }
                else {
                    el.value = value;
                }
            }
            else {
                el.textContent = value;
                if ('textContent' in el) {
                    el.textContent = value;
                }
                else {
                    el.innerText = value; // IE8 support
                }
            }
        }
        else if (attr == 'style' && parts[2]) {
            // e.g. team1_colors.style.background = blue
            el.style[parts[2]] = value;
            // TODO: properly handle team1_colors.style: {color: white, background: blue}
        }
        else {
            el[attr] = value;
        }
    }
}

function setMultiValues(el, context) {
    Object.keys(context).forEach(function(key){
        setValues(el, key, context[key]);
    });
}

function render(template, globals, locals) {
    template = template || '';
    var context = Object.assign({}, globals);
    context = Object.assign(context, locals);

    var container = document.createElement('div');
    var html = template.innerHTML || template;
    container.innerHTML = html.trim();
    var el = container.firstChild;

    setMultiValues(el, context);

    return el;
}

// -------- main --------

var globals = {};

if (document.location.search) {
    globals = parseQuery(document.location.search);
    setMultiValues($("#set-globals"), globals);
}
else {
    globals = getValues($("#set-globals"));
}

$("#set-globals").onsubmit = function(event) {
    globals = getValues(event.target);
    setMultiValues($('#main'), globals);
    $("#show-config").click();
    // return false;
}

function renderMain() {
    var main = $("#main");
    main.innerHTML = '';
    for (var i = 1; i <= 7; i++) {
        var locals = { game_no: i }
        if (i >= 5) {
            var play = render($('#play-chance-template'), globals, locals);
            main.append(play);
        }
        var game = render($('#game-template'), globals, locals);
        main.append(game);
        if (i >= 4) {
            var win = render($('#final-win-template'), globals, locals);
            main.append(win);
        }
    }
}

function updateMeters(input) {
    var game = parent(input, "#main");
    setMultiValues(game, {
        team1_pct: input.value,
        team2_pct: 100-input.value,
        "team1.style.width": input.value + "%",
        "team2.style.width": 100-input.value + "%"
    });
}

// team1_probs = [1, 1, 0, 0.50, 0.50, 0.50, 0.50];
// team2_probs = [];
// team1_won_yet = [];
// team2_won_yet = [];
//             for (var max_games = 0; max_games < 7; max_games++) {
//                 team1_won_yet[max_games] = seriesProb(0, 0, max_games, team1_probs);
//                 team2_won_yet[max_games] = seriesProb(0, 0, max_games, team2_probs);
//             }
// function seriesProb (game, wins, max_games, prob) {
//     if (wins >= 4) {
//         return 1;
//     }
//     else if (game - wins >= 4) {
//         return 0
//     }
//     else if (game > max_games) {
//         return 0;
//     }
//     else {
//         return(seriesProb(game+1, wins, max_games, prob) * (1-prob[game])
//              + seriesProb(game+1, wins+1, max_games, prob) * (prob[game]));
//     }
// }

renderMain();

</script>
